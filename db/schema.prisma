generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

model User {
  id                String              @id @default(cuid())
  email             String              @unique
  name              String?
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  apiKeys           ApiKey[]
  group_invitations group_invitations[]
  groupMemberships  GroupMember[]
  location_shares   location_shares[]

  @@map("users")
}

model Group {
  id                String              @id @default(cuid())
  name              String
  description       String?
  ownerId           String              @map("owner_id")
  apiBaseUrl        String?             @map("api_base_url")
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  apiKeys           ApiKey[]
  group_invitations group_invitations[]
  members           GroupMember[]
  location_shares   location_shares[]
  locations         Location[]

  @@map("groups")
}

model GroupMember {
  id        String   @id @default(cuid())
  groupId   String   @map("group_id")
  userId    String   @map("user_id")
  status    String   @default("pending")
  createdAt DateTime @default(now()) @map("created_at")
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@map("group_members")
}

model Location {
  id             String   @id @default(cuid())
  groupId        String   @map("group_id")
  deviceId       String   @map("device_id")
  latitude       Float
  longitude      Float
  accuracy       Float?
  speed          Float?
  heading        Float?
  recordedAt     DateTime @map("recorded_at")
  receivedAt     DateTime @default(now()) @map("received_at")
  payloadVersion String   @default("v1") @map("payload_version")
  metadata       String?
  group          Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([deviceId])
  @@index([recordedAt])
  @@map("locations")
}

model ApiKey {
  id           String    @id @default(cuid())
  groupId      String    @map("group_id")
  userId       String?   @map("user_id")
  label        String
  hashedSecret String    @map("hashed_secret")
  lastUsedAt   DateTime? @map("last_used_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  revokedAt    DateTime? @map("revoked_at")
  group        Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user         User?     @relation(fields: [userId], references: [id])

  @@index([groupId])
  @@map("api_keys")
}

model group_invitations {
  id          String    @id
  group_id    String
  user_id     String
  invited_by  String
  status      String    @default("pending")
  expires_at  DateTime?
  created_at  DateTime  @default(now())
  updated_at  DateTime
  accepted_at DateTime?
  rejected_at DateTime?
  groups      Group     @relation(fields: [group_id], references: [id], onDelete: Cascade)
  users       User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([group_id, user_id])
  @@index([expires_at])
  @@index([group_id])
  @@index([status])
  @@index([user_id])
}

model location_shares {
  id         String    @id
  user_id    String
  group_id   String
  device_id  String?
  started_at DateTime  @default(now())
  ended_at   DateTime?
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now())
  updated_at DateTime
  duration   Int?      @map("duration")
  frequency  Int?      @map("frequency")
  groups     Group     @relation(fields: [group_id], references: [id], onDelete: Cascade)
  users      User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([group_id])
  @@index([is_active])
  @@index([started_at])
  @@index([user_id])
}
